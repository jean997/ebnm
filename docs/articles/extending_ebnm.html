<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extending ebnm with custom ebnm-style functions • ebnm</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Extending ebnm with custom ebnm-style functions">
<meta property="og:description" content="ebnm">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ebnm</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1-20</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/stephenslab/ebnm" class="external-link">Source</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Extending ebnm with custom ebnm-style
functions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/stephenslab/ebnm/blob/HEAD/vignettes/extending_ebnm.Rmd" class="external-link"><code>vignettes/extending_ebnm.Rmd</code></a></small>
      <div class="hidden name"><code>extending_ebnm.Rmd</code></div>

    </div>

    
    
<p>The ebnm package, in addition to providing implementations of several
popular priors (normal, Laplace, etc.), was also designed to be easy
extensible so that analysts are not limited by the priors we have
implemented. Here we show by example how to extend ebnm by creating a
custom EBNM solver in the style of other ebnm functions
(<code><a href="../reference/ebnm_normal.html">ebnm_normal()</a></code>, <code><a href="../reference/ebnm_point_laplace.html">ebnm_point_laplace()</a></code>, etc.).
In this example, we will implement empirical Bayes normal means a scaled
(Student’s) <em>t</em> prior, which is not currently one of the prior
families included in the ebnm package.</p>
<p>The normal means model with a scaled <em>t</em> prior assigned to the
unknown means is</p>
<span class="math display">\[\begin{aligned}
x_i &amp;\sim \mathcal{N}(\theta_i, s_i^2), \\
\theta_i &amp;\sim g \in \mathcal{G},
\end{aligned}\]</span>
<p>in which the prior family <span class="math inline">\(\mathcal{G}\)</span> is</p>
<p><span class="math display">\[\begin{equation}
\mathcal{G} = \{g: g = \sigma t_\nu; \sigma &gt; 0, \nu &gt; 0\},
\end{equation}\]</span></p>
<p>and where <span class="math inline">\(t_{\nu}\)</span> is the
<em>t</em> distribution with <span class="math inline">\(\nu\)</span>
degress of freedom. Fitting the prior therefore involves estimating two
parameters: the scale parameter, <span class="math inline">\(\sigma\)</span>; and the degrees of freedom, <span class="math inline">\(\nu\)</span>.</p>
<div class="section level2">
<h2 id="the-prior-family-class">The prior family class<a class="anchor" aria-label="anchor" href="#the-prior-family-class"></a>
</h2>
<p>First we will need a class that specifies the structure of the priors
<span class="math inline">\(g\)</span> in our prior family <span class="math inline">\(\mathcal{G}\)</span>. In some cases, an existing
class can be used. For example, <code><a href="../reference/ebnm_normal.html">ebnm_normal()</a></code>,
<code><a href="../reference/ebnm_point_normal.html">ebnm_point_normal()</a></code>,
<code><a href="../reference/ebnm_normal_scale_mixture.html">ebnm_normal_scale_mixture()</a></code>, and
<code><a href="../reference/ebnm_point_mass.html">ebnm_point_mass()</a></code> all use the class
<code>"normalmix"</code>, which in turn was borrowed from the
<strong>ashr</strong> package. In other cases, a new class must be
created.</p>
<p><strong>ebnm</strong> uses these classes in two ways: first, to give
information about the fitted prior <span class="math inline">\(\hat{g}\)</span> via the <code>fitted_g</code>
field in the returned <code>"ebnm"</code> object; and second, to
initialize solutions using the <code>g_init</code> argument. If one
would like to be able to arbitrarily initialize the solver, then the
prior family class should include all information required to do so.
Note, however, that <code>ebnm</code> places no restrictions whatsoever
on the structure of the class, since any initialization using
<code>g_init</code> must be implemented within the custom function
itself. In particular, we could choose to simply ignore
<code>g_init</code> and return <code>fitted_g = NULL</code> (this is not
recommended, of course, since it gives no information about the fitted
prior <span class="math inline">\(\hat{g} \in \mathcal{G}\)</span>).</p>
<p>For our custom solver, we will create a <code>"tdist"</code> class
that includes the scale and degrees of freedom. We create a constructor
function for the class as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tdist</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">scale</span>, <span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">scale</span>, <span class="va">df</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"tdist"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="the-optimization-function">The optimization function<a class="anchor" aria-label="anchor" href="#the-optimization-function"></a>
</h2>
<p>The optimization function comprises the “guts” of the solver; it
(optionally) takes initialization parameters as input and
(non-optionally) returns optimal values for the parameters of interest.
Details will be specific to the prior family, but in general a
maximum-likelihood approach can be implemented as follows:</p>
<ol style="list-style-type: decimal">
<li>Create a function that calculates the log likelihood:</li>
</ol>
<p><span class="math display">\[\begin{equation}
L(g) :=  p(\mathbf{x} \mid g, \, \mathbf{s}) =
\prod_{i=1}^n \textstyle
\int p(x_i \mid \theta_i, s_i) \, g(\theta_i) \, d\theta_i
\end{equation}\]</span></p>
<ol start="2" style="list-style-type: decimal">
<li>Use an off-the-shelf method such as <code><a href="https://rdrr.io/r/stats/nlm.html" class="external-link">nlm()</a></code> or
<code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> to maximize <span class="math inline">\(L(g)\)</span>:</li>
</ol>
<p><span class="math display">\[\begin{equation}
\hat{g} :=
\text{argmax}_{g \,\in\, \mathcal{G}} L(g)
\end{equation}\]</span></p>
<p>To implement the first step, we use numerical methods (namely, the
<code><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate()</a></code> function from the base R <strong>stats</strong>
package) to compute the convolution of the prior <span class="math inline">\(t\)</span> density with normal noise:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">llik_t</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">tau</span>, <span class="va">nu</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">llik_one_obs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">theta</span>, sd <span class="op">=</span> <span class="va">s</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">dt</a></span><span class="op">(</span><span class="va">theta</span> <span class="op">/</span> <span class="va">tau</span>, df <span class="op">=</span> <span class="va">nu</span><span class="op">)</span> <span class="op">/</span> <span class="va">tau</span></span>
<span>    <span class="op">}</span>, lower <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, upper <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span><span class="op">$</span><span class="va">value</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">vllik</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Vectorize.html" class="external-link">Vectorize</a></span><span class="op">(</span><span class="va">llik_one_obs</span><span class="op">)</span> </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu">vllik</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For the second step, we use the <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> function (again
available in the <strong>stats</strong> package) to optimize over
possible values of <code>tau</code> and <code>nu</code>. We use
<code>method = "L-BFGS-B"</code> since it allows us to constrain both
parameters to be nonnegative. To avoid potential optimization issues, we
set sensible lower and upper bounds for both <code>tau</code> and
<code>nu</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opt_t</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">tau_init</span>, <span class="va">nu_init</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># optim only does minimization, so we provide the negative log likelihood:</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span>par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tau_init</span>, <span class="va">nu_init</span><span class="op">)</span>, </span>
<span>        fn <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">-</span><span class="fu">llik_t</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, </span>
<span>        method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,</span>
<span>        lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>        upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">1e3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="calculating-posteriors">Calculating posteriors<a class="anchor" aria-label="anchor" href="#calculating-posteriors"></a>
</h2>
<p>Given an optimal <span class="math inline">\(\hat{g} \in
\mathcal{G}\)</span>, we can obtain point estimates for the “true means”
<span class="math inline">\(\theta_i\)</span> using posterior means
<span class="math inline">\(\mathbb{E}(\theta_i \mid x_i, s_i,
\hat{g})\)</span>. In general, we might like to compute various
summaries about the posterior:</p>
<p><span class="math display">\[\begin{equation}
p(\theta_i \mid x_i, s_i, \hat{g}) \propto
\hat{g}(\theta_i) \, p(x_i \mid \theta_i, s_i),
\end{equation}\]</span></p>
<p>including, for example, posterior standard deviations, second
moments, and local false sign rates <span class="citation">(Stephens
2017)</span>. If the EBNM solver is intended for use in the
<strong>flashier</strong> package, then posterior means
(<code>mean</code>) and second moments (<code>second_moment</code>)
<em>must</em> be computed.</p>
<p>Since posteriors are not analytically available for <span class="math inline">\(t\)</span> priors, we implement an MCMC sampler
using the <strong>mcmc</strong> package and then compute summaries using
10000 samples from each posterior. The following code is principally for
purposes of illustration; in particular, speed and efficiency could
likely be improved.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post_sampler</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">tau</span>, <span class="va">nu</span>, <span class="va">nsamp</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sample_one_theta</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x_i</span>, <span class="va">s_i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">lpostdens</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">dt</a></span><span class="op">(</span><span class="va">theta</span> <span class="op">/</span> <span class="va">tau</span>, df <span class="op">=</span> <span class="va">nu</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">tau</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x_i</span> <span class="op">-</span> <span class="va">theta</span>, sd <span class="op">=</span> <span class="va">s_i</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu">mcmc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mcmc/man/metrop.html" class="external-link">metrop</a></span><span class="op">(</span><span class="va">lpostdens</span>, initial <span class="op">=</span> <span class="va">x_i</span>, nbatch <span class="op">=</span> <span class="va">nsamp</span><span class="op">)</span><span class="op">$</span><span class="va">batch</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">vsampler</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Vectorize.html" class="external-link">Vectorize</a></span><span class="op">(</span><span class="va">sample_one_theta</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">vsampler</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">post_summaries</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">tau</span>, <span class="va">nu</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">samp</span> <span class="op">&lt;-</span> <span class="fu">post_sampler</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">tau</span>, <span class="va">nu</span>, nsamp <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">samp</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span>,</span>
<span>    sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">samp</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>,</span>
<span>    second_moment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">samp</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="putting-everything-together">Putting everything together<a class="anchor" aria-label="anchor" href="#putting-everything-together"></a>
</h2>
<p>We now have all the ingredients required for our custom EBNM solver.
We should ensure that inputs are the same as for function
<code><a href="../reference/ebnm.html">ebnm()</a></code> (and we will also use the same defaults). We can
simply ignore parameters that we do not want to implement. The
<code>optmethod</code> parameter can typically be ignored unless we want
to make multiple optimization methods available for a single prior
family (e.g., both <code><a href="https://rdrr.io/r/stats/nlm.html" class="external-link">nlm()</a></code> and <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code>). We will
also ignore the <code>control</code> parameter, although it could be
used here, for example, to alter the default settings of
<code>lower</code> and <code>upper</code> in the call to
<code>optim</code>. Finally, for simplicity, we will ignore the
<code>output</code> parameter and just return everything (the data, the
posterior summaries, the fitted prior, the log likelihood, and the
posterior sampler). See <code><a href="../reference/ebnm.html">?ebnm</a></code> for further details about the
expected structure of the returned <code>"ebnm"</code> object.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebnm_t</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, </span>
<span>                   <span class="va">s</span> <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                   <span class="va">mode</span> <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                   <span class="va">scale</span> <span class="op">=</span> <span class="st">"estimate"</span>, </span>
<span>                   <span class="va">g_init</span> <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                   <span class="va">fix_g</span> <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                   <span class="va">output</span> <span class="op">=</span> <span class="fu"><a href="../reference/ebnm.html">ebnm_output_default</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   <span class="va">optmethod</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                   <span class="va">control</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Basic argument checks.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">mode</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"The mode of the t-prior must be fixed at zero."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">scale</span> <span class="op">!=</span> <span class="st">"estimate"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"The scale of the t-prior must be estimated rather than fixed at a particular value."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># If g_init is provided, extract the parameters.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">g_init</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">tau_init</span> <span class="op">&lt;-</span> <span class="va">g_init</span><span class="op">$</span><span class="va">scale</span></span>
<span>    <span class="va">nu_init</span> <span class="op">&lt;-</span> <span class="va">g_init</span><span class="op">$</span><span class="va">df</span></span>
<span>  <span class="op">}</span> </span>
<span>  <span class="co"># Otherwise, use sensible defaults.</span></span>
<span>  <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">tau_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">nu_init</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Perform the optimization.</span></span>
<span>  <span class="va">opt_res</span>  <span class="op">&lt;-</span> <span class="fu">opt_t</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">tau_init</span>, <span class="va">nu_init</span><span class="op">)</span></span>
<span>  <span class="va">opt_tau</span>  <span class="op">&lt;-</span> <span class="va">opt_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">opt_nu</span>   <span class="op">&lt;-</span> <span class="va">opt_res</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">opt_llik</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">opt_res</span><span class="op">$</span><span class="va">value</span></span>
<span>  </span>
<span>  <span class="co"># Create the return object.</span></span>
<span>  <span class="va">ebnm_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, s <span class="op">=</span> <span class="va">s</span><span class="op">)</span>,</span>
<span>    posterior <span class="op">=</span> <span class="fu">post_summaries</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">opt_tau</span>, <span class="va">opt_nu</span><span class="op">)</span>,</span>
<span>    fitted_g <span class="op">=</span> <span class="fu">tdist</span><span class="op">(</span>scale <span class="op">=</span> <span class="va">opt_tau</span>, df <span class="op">=</span> <span class="va">opt_nu</span><span class="op">)</span>,</span>
<span>    log_likelihood <span class="op">=</span> <span class="va">opt_llik</span>,</span>
<span>    post_sampler <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">nsamp</span><span class="op">)</span> <span class="fu">post_sampler</span><span class="op">(</span><span class="va">x</span>, <span class="va">s</span>, <span class="va">opt_tau</span>, <span class="va">opt_nu</span>, <span class="va">nsamp</span><span class="op">)</span></span>
<span>  <span class="op">)</span>, class <span class="op">=</span> <span class="st">"ebnm"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">ebnm_res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="illustration">Illustration<a class="anchor" aria-label="anchor" href="#illustration"></a>
</h2>
<p>To test our function, we simulate from a <span class="math inline">\(t\)</span> prior with 5 degrees of freedom and
with the scale parameter <span class="math inline">\(\tau = 2\)</span>.
We then add noise simulated from a standard normal distribution. We set
a seed for reproducibility:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">rt</a></span><span class="op">(</span><span class="fl">100</span>, df <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">theta</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p>Next we fit EBNM models using: 1. the family of normal priors, as
implemented by <code><a href="../reference/ebnm_normal.html">ebnm_normal()</a></code>; 2. the family of <span class="math inline">\(t\)</span> priors that we just implemented. Due to
our reliance on MCMC sampling to calculate posterior means, fitting the
second model is much slower than the first (it took us about 15 seconds
on a new MacBook Pro). We compare results using the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>
method for <code>"ebnm"</code> objects:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/stephenslab/ebnm" class="external-link">"ebnm"</a></span><span class="op">)</span></span>
<span><span class="va">normal_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ebnm_normal.html">ebnm_normal</a></span><span class="op">(</span><span class="va">x</span>, s <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">t_res</span> <span class="op">&lt;-</span> <span class="fu">ebnm_t</span><span class="op">(</span><span class="va">x</span>, s <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">normal_res</span>, <span class="va">t_res</span><span class="op">)</span></span></code></pre></div>
<p><img src="extending_ebnm_files/figure-html/unnamed-chunk-7-1.png" width="540" style="display: block; margin: auto;"></p>
<p>Note that <code>ebnm_t()</code> shrinks smaller observations more
aggressively while estimates for larger observations remain close to
their original values. As a result, the accuracy (root mean-squared
error) of the estimates improves:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rmse_normal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">normal_res</span><span class="op">)</span> <span class="op">-</span> <span class="va">theta</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rmse_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">t_res</span><span class="op">)</span> <span class="op">-</span> <span class="va">theta</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rmse_normal"</span> <span class="op">=</span> <span class="va">rmse_normal</span>, <span class="st">"rmse_t"</span> <span class="op">=</span> <span class="va">rmse_t</span><span class="op">)</span></span>
<span><span class="co"># rmse_normal      rmse_t </span></span>
<span><span class="co">#   0.9017232   0.8703657</span></span></code></pre></div>
<p>This improvement is as expected, since the true prior <span class="math inline">\(g\)</span> used to simulate the data belongs to
the family of <span class="math inline">\(t\)</span> distributions but
not the family of normal distributions. And indeed, the estimated prior
parameters end up being similar to the parameters used to simulate the
data (<span class="math inline">\(\tau = 2\)</span> and <span class="math inline">\(\nu = 5\)</span>):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t_res</span><span class="op">$</span><span class="va">fitted_g</span></span>
<span><span class="co"># $scale</span></span>
<span><span class="co"># [1] 1.856682</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># $df</span></span>
<span><span class="co"># [1] 2.862615</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># attr(,"class")</span></span>
<span><span class="co"># [1] "tdist"</span></span>
<span><span class="co"># attr(,"row.names")</span></span>
<span><span class="co"># [1] 1</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<p>The following R version and packages were used to generate this
vignette:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># R version 4.3.2 (2023-10-31)</span></span>
<span><span class="co"># Platform: aarch64-apple-darwin20 (64-bit)</span></span>
<span><span class="co"># Running under: macOS Monterey 12.3</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Matrix products: default</span></span>
<span><span class="co"># BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib </span></span>
<span><span class="co"># LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># locale:</span></span>
<span><span class="co"># [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># time zone: America/New_York</span></span>
<span><span class="co"># tzcode source: internal</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># attached base packages:</span></span>
<span><span class="co"># [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># other attached packages:</span></span>
<span><span class="co"># [1] ebnm_1.1-20</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># loaded via a namespace (and not attached):</span></span>
<span><span class="co">#  [1] sass_0.4.8         utf8_1.2.4         generics_0.1.3     ashr_2.2-63       </span></span>
<span><span class="co">#  [5] stringi_1.8.3      lattice_0.21-9     digest_0.6.34      magrittr_2.0.3    </span></span>
<span><span class="co">#  [9] RColorBrewer_1.1-3 evaluate_0.23      grid_4.3.2         fastmap_1.1.1     </span></span>
<span><span class="co"># [13] jsonlite_1.8.8     Matrix_1.6-1.1     mcmc_0.9-8         mixsqp_0.3-54     </span></span>
<span><span class="co"># [17] purrr_1.0.2        fansi_1.0.6        scales_1.3.0       truncnorm_1.0-9   </span></span>
<span><span class="co"># [21] invgamma_1.1       textshaping_0.3.7  jquerylib_0.1.4    cli_3.6.2         </span></span>
<span><span class="co"># [25] rlang_1.1.3        deconvolveR_1.2-1  munsell_0.5.0      splines_4.3.2     </span></span>
<span><span class="co"># [29] withr_2.5.2        cachem_1.0.8       yaml_2.3.8         tools_4.3.2       </span></span>
<span><span class="co"># [33] SQUAREM_2021.1     memoise_2.0.1      dplyr_1.1.4        colorspace_2.1-0  </span></span>
<span><span class="co"># [37] ggplot2_3.4.4      vctrs_0.6.5        R6_2.5.1           lifecycle_1.0.4   </span></span>
<span><span class="co"># [41] stringr_1.5.1      fs_1.6.3           trust_0.1-8        ragg_1.2.7        </span></span>
<span><span class="co"># [45] irlba_2.3.5.1      pkgconfig_2.0.3    desc_1.4.3         pkgdown_2.0.7     </span></span>
<span><span class="co"># [49] bslib_0.6.1        pillar_1.9.0       gtable_0.3.4       glue_1.7.0        </span></span>
<span><span class="co"># [53] Rcpp_1.0.12        systemfonts_1.0.5  highr_0.10         xfun_0.41         </span></span>
<span><span class="co"># [57] tibble_3.2.1       tidyselect_1.2.0   rstudioapi_0.15.0  knitr_1.45        </span></span>
<span><span class="co"># [61] farver_2.1.1       htmltools_0.5.7    labeling_0.4.3     rmarkdown_2.25    </span></span>
<span><span class="co"># [65] compiler_4.3.2     horseshoe_0.2.0</span></span></code></pre></div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Stephens_NewDeal" class="csl-entry">
Stephens, Matthew. 2017. <span>“False Discovery Rates: A New
Deal.”</span> <em>Biostatistics</em> 18 (2): 275–94.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jason Willwerscheid, Matthew Stephens, Peter Carbonetto.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
